<%- include('../includes/head.ejs', { username: username, permisos: permisos, rol: rol }) %>
    <script type="text/javascript" src="/js/modal_popup.js"></script>

    <style>
        input:focus {
            border: 2px solid #910106 !important
        }

        input:hover {
            border: 2px solid #5a6581 !important;
        }

        .button:hover {
            background-color: #5a6581 !important;
            border-color: #910106 !important;
        }

        .search-bar {
            margin-bottom: 20px;
        }

        .search-input {
            width: 100%;
            padding: 10px;
            font-size: 16px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
        }

        .table-container {
            position: relative;
        }

        .pagination-container {
            margin-top: 20px;
        }

        .pagination-btn {
            margin: 0 5px;
        }
    </style>

    <body>
        <section class="section">
            <div class="container">
                <div class="columns">
                    <div class="column is-6">
                        <h3 class="title is-3">Configuración Usuarios</h3>
                    </div>
                    <% if (contienePermiso(permisos, 'Registrar usuario' )==true) { %>
                        <div class="column is-offset-2">
                            <p class="control">
                                <a class="button is-rounded is-responsive" style="font-size: large;"
                                    href="/configuracion/registrar_usuario">
                                    <span class="icon is-large">
                                        <i class="fa-solid fa-circle-plus"></i>
                                    </span>
                                    <span>
                                        Registrar Usuario
                                    </span>
                                </a>
                            </p>
                        </div>
                        <% } %>
                </div>

                <input type="hidden" name="_csrf" id="_csrf" value="<%= csrfToken %>">

                <div class="tabs is-boxed">
                    <ul>
                        <li class="is-active" id="nav_activos">
                            <a onclick="usuarios_activos()">
                                <span class="icon is-small"><i class="fa-solid fa-users"></i></span>
                                <span>Usuarios Activos</span>
                            </a>
                        </li>
                        <li id="nav_no_activos">
                            <a onclick="usuarios_no_activos()">
                                <span class="icon is-small"><i class="fa-regular fa-users-slash"></i></span>
                                <span>Usuarios No Activos</span>
                            </a>
                        </li>
                    </ul>
                </div>

                <div id="usuarios_activos">
                    <% let count_activos=0 %>

                        <div id="modificacion_estatus_activar" class="notification is-hidden"
                            style="background-color: #5a6581; color:#ffffff;">
                            <button id="btn_eliminar_estatus" class="delete"></button>
                            ¡Usuario Desactivado! Recargando datos...
                        </div>

                        <% if (usuariosActivos.length===0) { %>
                            <p>No hay usuarios activos por el momento.</p>
                            <% } else { %>
                                <div class="search-bar">
                                    <input type="text" id="searchActivos" class="search-input"
                                        placeholder="Buscar usuarios activos">
                                </div>
                                <div id="tablaActivos" class="table-container">
                                    <table class="table is-bordered is-hoverable is-fullwidth">
                                        <thead>
                                            <tr>
                                            <tr>
                                                <th>
                                                    <p class="is-size-5"><strong>Nombre: </strong></p>
                                                </th>
                                                <th>
                                                    <p class="is-size-5"><strong>Email: </strong></p>
                                                </th>
                                                <th>
                                                    <p class="is-size-5"><strong>Status: </strong></p>
                                                </th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <% for (let usuario of usuariosActivos) { %>
                                                <tr>
                                                    <td>
                                                        <%= usuario.IDUsuario %>
                                                    </td>
                                                    <td>
                                                        <%= usuario.correoElectronico %>
                                                    </td>
                                                    <td>
                                                        <form id="form_activar_usuario" method="POST"
                                                            action="/configuracion/modificar_usuario">
                                                            <input type="hidden" name="_csrf" id="_csrf"
                                                                value="<%= csrfToken %>">
                                                            <input type="hidden" name="IDUsuario"
                                                                value="<%= usuario.IDUsuario %>">
                                                            <input type="hidden" name="statusUsuario" value="off">
                                                            <button type="submit"
                                                                class="button is-danger">Desactivar</button>
                                                        </form>
                                                    </td>
                                                </tr>
                                                <% count_activos++ %>
                                                    <% } %>
                                        </tbody>
                                    </table>
                                </div>
                                <% } %>
                </div>

                <div id="usuarios_no_activos" class="is-hidden">
                    <% let count_no_activos=0 %>

                        <div id="modificacion_estatus_desactivar" class="notification is-hidden"
                            style="background-color: #5a6581; color:#ffffff;">
                            <button id="btn_eliminar_estatus" class="delete"></button>
                            ¡Usuario Activado! Recargando datos...
                        </div>

                        <% if (usuariosNoActivos.length===0) { %>
                            <p>No hay usuarios no activos por el momento.</p>
                            <% } else { %>
                                <div class="search-bar">
                                    <input type="text" id="searchNoActivos" class="search-input"
                                        placeholder="Buscar usuarios no activos">
                                </div>
                                <div id="tablaNoActivos" class="table-container">
                                    <table class="table is-bordered is-hoverable is-fullwidth">
                                        <thead>
                                            <tr>
                                                <th>
                                                    <p class="is-size-5"><strong>Nombre: </strong></p>
                                                </th>
                                                <th>
                                                    <p class="is-size-5"><strong>Email: </strong></p>
                                                </th>
                                                <th>
                                                    <p class="is-size-5"><strong>Status: </strong></p>
                                                </th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <% for (let usuario of usuariosNoActivos) { %>
                                                <tr>
                                                    <td>
                                                        <%= usuario.IDUsuario %>
                                                    </td>
                                                    <td>
                                                        <%= usuario.correoElectronico %>
                                                    </td>
                                                    <td>
                                                        <form id="form_desactivar_usuario"="POST"
                                                            action="/configuracion/modificar_usuario">
                                                            <input type="hidden" name="_csrf" id="_csrf"
                                                                value="<%= csrfToken %>">
                                                            <input type="hidden" name="IDUsuario"
                                                                value="<%= usuario.IDUsuario %>">
                                                            <input type="hidden" name="statusUsuario" value="on">
                                                            <button type="submit"
                                                                class="button is-success">Activar</button>
                                                        </form>
                                                    </td>
                                                </tr>
                                                <% count_no_activos++ %>
                                                    <% } %>
                                        </tbody>
                                    </table>
                                </div>
                                <% } %>
                </div>
            </div>
        </section>
        <script>
            $(document).ready(function () {
                // Función para manejar la búsqueda en la tabla de usuarios activos
                $('#searchActivos').on('input', function () {
                    const consulta = $(this).val().toLowerCase();
                    $('#tablaActivos tbody tr').filter(function () {
                        $(this).toggle($(this).text().toLowerCase().indexOf(consulta) > -1);
                    });
                });

                // Función para manejar la búsqueda en la tabla de usuarios no activos
                $('#searchNoActivos').on('input', function () {
                    const consulta = $(this).val().toLowerCase();
                    $('#tablaNoActivos tbody tr').filter(function () {
                        $(this).toggle($(this).text().toLowerCase().indexOf(consulta) > -1);
                    });
                });
            });

            /* Funciones para alternar entre usuarios activos y no activos */
            function usuarios_activos() {
                const tab_no_activos = document.querySelector('#nav_no_activos');
                const tab_activos = document.querySelector('#nav_activos');

                tab_no_activos.classList.remove('is-active');
                tab_activos.classList.add('is-active');

                const usuarios_no_activos = document.querySelector('#usuarios_no_activos');
                usuarios_no_activos.classList.add('is-hidden');

                const usuarios_activos = document.querySelector('#usuarios_activos');
                usuarios_activos.classList.remove('is-hidden');
            }

            function usuarios_no_activos() {
                const tab_no_activos = document.querySelector('#nav_no_activos');
                const tab_activos = document.querySelector('#nav_activos');

                tab_no_activos.classList.add('is-active');
                tab_activos.classList.remove('is-active');

                const usuarios_no_activos = document.querySelector('#usuarios_no_activos');
                usuarios_no_activos.classList.remove('is-hidden');

                const usuarios_activos = document.querySelector('#usuarios_activos');
                usuarios_activos.classList.add('is-hidden');
            }

            $(document).ready(function () {
    // Función para mostrar la notificación y recargar la página
    function mostrarNotificacionYRecargar(tabla, notificacion) {
        $(notificacion).removeClass('is-hidden'); // Mostrar notificación

        // Recargar la página después de mostrar la notificación por 3 segundos (3000 milisegundos)
        setTimeout(function () {
            window.location.reload(); // Recargar la página
        }, 1500);
    }

    // Mostrar la notificación y recargar la página después de enviar cualquier formulario
    $('form').submit(function (event) {
        event.preventDefault(); // Evitar que el formulario se envíe automáticamente

        $.ajax({
            type: 'POST',
            url: $(this).attr('action'), // Obtener la URL del formulario actual
            data: $(this).serialize(),
            success: function () {
                // Buscar la tabla y la notificación relacionadas con el formulario enviado
                var tabla = $(event.target).closest('.table-container').find('table');
                var notificacion = $(event.target).closest('.table-container').siblings('.notification');

                mostrarNotificacionYRecargar(tabla, notificacion);
            },
            error: function () {
                console.log('Error al enviar el formulario');
            }
        });
    });

    // Cerrar notificación al hacer clic en el botón eliminar
    $('.delete').click(function () {
        $(this).parent().addClass('is-hidden'); // Ocultar notificación al hacer clic en el botón eliminar
    });
});



        </script>
    </body>

    </html>