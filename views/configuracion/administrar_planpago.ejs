<%- include('../includes/head.ejs') %>

    <section class="section">
        <div class="container">
            <div class="columns">
                <div class="column is-6">
                    <h3 class="title is-3" style="margin-bottom: 0;">Planes de Pago</h3>
                </div>
                <% if (contienePermiso(permisos, 'Registrar Plan de Pago' )==true) { %>
                    <div class="column is-offset-2">
                        <p class="control" style="margin-bottom: 0;">
                            <a class="button is-rounded is-responsive" style="font-size: large;"
                                href="/configuracion/registrar_planpago">
                                <span class="icon is-large">
                                    <i class="fa-solid fa-circle-plus"></i>
                                </span>
                                <span>
                                    Registrar Plan de Pago
                                </span>
                            </a>
                        </p>
                    </div>
                    <% } %>
            </div>

            <% if (contienePermiso(permisos, 'Modificar Plan de Pago' )==true) { %>
                <div class="container" style="display: flex; justify-content: center;">
                    <div id="modificacion_plan_pago" class="notificationPlanPago is-hidden"
                        style="background-color: #5a6581; color:#ffffff;">
                        <button id="btn_eliminar_estatus" class="delete"></button>
                        ¡Plan de Pago Modificado! Recargando datos...
                    </div>
                    <div class="content" style="width: 70%; margin-top: 50px;">
                        <% planpago.forEach((plan, index)=> { %>
                            <div class="card" style="margin-bottom: 20px; border: 5px solid #910106;">
                                <div class="card-content">
                                    <div class="media">
                                        <div class="media-content">
                                            <form id="formModificarPlanPago<%= index %>" class="formModificarPlanPago"
                                                action="/configuracion/modificar_planpago" method="POST"></form>
                                            <input type="hidden" name="_csrf" id="_csrf" value="<%= csrfToken %>">
                                            <input type="hidden" name="IDPlanPago" value="<%= plan.IDPlanPago %>" />
                                            <div class="field">
                                                <label class="label">Nombre del Plan</label>
                                                <div class="control">
                                                    <input required class="input" type="text" name="nombrePlan"
                                                        id="nombrePlan<%= index %>" value="<%= plan.nombrePlan %>" />
                                                    <span id="errorNombre<%= index %>" class="help is-danger"
                                                        style="display: none;">Por favor rellena el nombre</span>
                                                </div>
                                            </div>
                                            <div class="field">
                                                <label class="label">Número de Pagos</label>
                                                <div class="control">
                                                    <input class="input" type="text" name="numeroPagos"
                                                        value="<%= plan.numeroPagos %>" disabled />
                                                </div>
                                            </div>
                                            <div class="field">
                                                <label class="label">Estado</label>
                                                <div class="control">
                                                    <div class="select">
                                                        <select name="planPagoActivo">
                                                            <option value="1" <% if (plan.planPagoActivo===1) { %>
                                                                selected <% } %>>Activo</option>
                                                            <option value="0" <% if (plan.planPagoActivo !==1) { %>
                                                                selected <% } %>>No Activo</option>
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>
                                            <button id="btn_aplicar_cambios<%= index %>" type="submit"
                                                class="button is-large is-rounded is-responsive">Aplicar
                                                cambios</button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <% }) %>
                    </div>
                </div>



                <% } else { %>
                    <div class="container" style="display: flex; justify-content: center;">
                        <div class="content" style="width: 70%; margin-top: 50px;">
                            <h1 class="title is-2 has-text-centered">Planes de Pago</h1>
                            <% planpago.forEach(plan=> { %>
                                <div class="card" style="margin-bottom: 20px; border: 5px solid #910106;">
                                    <div class="card-content">
                                        <div class="media">
                                            <div class="media-content">
                                                <p class="title is-3 has-text-black">Nombre del Plan:</p>
                                                <p class="subtitle is-3 has-text-grey">
                                                    <%= plan.nombrePlan %>
                                                </p>
                                                <p class="title is-3 has-text-black">Número de Pagos:</p>
                                                <p class="subtitle is-3 has-text-grey">
                                                    <%= plan.numeroPagos %>
                                                </p>

                                                <p class="title is-3 has-text-black">Estado:</p>
                                                <p class="subtitle is-3 has-text-grey">
                                                    <% if (plan.planPagoActivo===1) { %>
                                                        Activo
                                                        <% } %>

                                                            <% if (plan.planPagoActivo===0) { %>
                                                                No Activo
                                                                <% } %>
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <% }) %>
                        </div>
                    </div>
                    <% } %>

                        <script>

                            $(document).ready(function () {
                                // Función para mostrar la notificación y recargar la página
                                function mostrarNotificacionYRecargar(notificacion) {
                                    $(notificacion).removeClass('is-hidden'); // Mostrar notificación

                                    // Recargar la página después de mostrar la notificación por 3 segundos (3000 milisegundos)
                                    setTimeout(function () {
                                        window.location.reload(); // Recargar la página
                                    }, 1500);
                                }

                                // Mostrar la notificación y recargar la página después de enviar un formulario
                                $('.formModificarPlanPago').submit(function (event) {
                                    event.preventDefault(); // Evitar que el formulario se envíe automáticamente

                                    $.ajax({
                                        type: 'POST',
                                        url: $(this).attr('action'), // Obtener la URL del formulario actual
                                        data: $(this).serialize(),
                                        success: function () {
                                            // Buscar la notificación relacionada con el formulario enviado
                                            var notificacion = $('.notificationPlanPago');

                                            mostrarNotificacionYRecargar(notificacion);
                                        },
                                        error: function () {
                                            console.log('Error al enviar el formulario');
                                        }
                                    });
                                });

                                // Cerrar notificación al hacer clic en el botón eliminar
                                $('.delete').click(function () {
                                    $(this).parent().addClass('is-hidden'); // Ocultar notificación al hacer clic en el botón eliminar
                                });
                            });
                        </script>