<%- include('../includes/head.ejs', {
    username: username,
    permisos: permisos,
    rol: rol
}) %>

<section class="section">
    <div class="container">
        <h1 class="title"> Realizar Pago</h1>
        <div class="columns">
            <div class="column is-4"></div>
            <div class="column is-offset-1">
                <input type="hidden" id="_csrf" name="_csrf" value="<%= csrfToken %>">
                <div class="columns">
                    <div class="column is-5">
                        <label class="label is-medium" for="motivo">Motivo: </label>
                    </div>
                    <div class="column">
                        <p class="help is-hidden has-text-danger-dark" id="ayuda_motivo"
                            style="padding: 0.5em; margin-top: -1em;">Por favor
                            escribe un motivo del pago del alumno</p>
                        <div class="field">
                            <p class="control has-icons-left">
                                <input name="motivo" class="input is-medium" type="text" id="motivo"
                                    placeholder="Concepto del pago">
                                <span class="icon is-small is-left">
                                    <i class="fa-solid fa-circle-info" style="color: #95404c;"></i>
                                </span>
                            </p>
                        </div>
                    </div>
                </div>
                <div class="columns">
                    <div class="column is-5">
                        <label class="label is-medium" for="monto">Monto:</label>
                    </div>
                    <div class="column">
                        <p class="help is-hidden has-text-danger-dark" id="ayuda_monto_vacio"
                            style="padding: 0.5em; margin-top: -1em;">
                            Por favor
                            escribe un monto válido del Pago</p>
                        <p class="help is-hidden has-text-danger-dark" id="ayuda_monto_negativo"
                            style="padding: 0.5em; margin-top: -1em;">Por
                            favor escribe un número mayor a 0.</p>
                        <p class="help is-hidden has-text-danger-dark" id="ayuda_monto_exponente"
                            style="padding: 0.5em; margin-top: -1em;">Por favor escribe un monto sin
                            exponente.
                        </p>
                        <div class="field">
                            <p class="control has-icons-left">
                                <input name="monto" class="input is-medium" type="number" step="any" id="monto"
                                    placeholder="Monto pagado" value="">
                                <span class="icon is-small is-left">
                                    <i class="fa-solid fa-dollar-sign" style="color: #95404c;"></i>
                                </span>
                            </p>
                        </div>
                    </div>
                </div>
                <div class="columns">
                    <div class="column is-5">
                        <label class="label is-medium" for="metodo">Método de Pago: </label>
                    </div>
                    <div class="column">
                        <div class="control has-icons-left">
                            <div class="select is-medium" style="width: 110%;">
                                <select name="metodo" id="metodo" style="width: 110%;">
                                    <option value="Web Tarjeta">
                                        Tarjeta
                                    </option>
                                    <option value="Efectivo">
                                        Efectivo
                                    </option>
                                    <option value="Transferencia">
                                        Transferencia
                                    </option>
                                </select>
                            </div>
                            <div class="icon is-medium is-left">
                                <i class="fa-solid fa-wallet" style="color: #95404c;"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="columns">
                    <div class="column is-5">
                        <label class="label is-medium" for="nota">Nota: </label>
                    </div>
                    <div class="column">
                        <textarea name="nota" id="nota" class="input is-medium"
                            placeholder="Escribe tu nota aquí."></textarea>
                    </div>
                </div>
                <div class="columns">
                    <div class="column is-2"></div>
                    <div class="column is-8">
                        <button class="js-modal-trigger button is-rounded is-medium is-responsive"
                            style="font-size: large; margin: 8px 2px;" id="Boton_pagar"
                            data-target="modal-pago-tarjeta">
                            <span>Realizar Pago</span>
                            <span class="icon is-large">
                                <i class="fa-solid fa-circle-chevron-right" style="color: #ffffff;"></i>
                            </span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <div id="modal-pago-tarjeta" class="modal">
            <div class="modal-background"></div>
            <div class="modal-card">
                <header class="modal-card-head">
                    <p class="modal-card-title" style="text-align: center;">
                        <strong>Pago de Colegiatura</strong>
                    </p>
                    <button type="button" class="delete" aria-label="delete"></button>
                </header>
                <section class="modal-card-body">
                    <iframe width="100%" height="470px" id="frame_pago"></iframe>
                </section>
            </div>
        </div>
    </div>
</section>
<script type="text/javascript" src="/js/modal_popup.js"></script>

<script>
    function pagar(monto) {
        //El token de protección CSRF
        const csrf = document.getElementById('_csrf').value;

        fetch('/pagos/mandar_pago', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'csrf-token': csrf
            },
            body: JSON.stringify({
                monto: monto.value
            })
        }).then((result) => {
            return result.json(); //Regresa otra promesa
        }).then((data) => {

            parser = new DOMParser();
            xmlDoc = parser.parseFromString(data.respuestaXML, "text/xml");

            let liga_pago = (xmlDoc.getElementsByTagName("nb_url")[0].childNodes[0].nodeValue);

            document.getElementById('frame_pago').src = liga_pago;

        }).catch(err => {
            console.log(err);
        });
    }

    const boton_pagar = document.getElementById('Boton_pagar');
    const monto = document.getElementById('monto');
    boton_pagar.addEventListener('click', function () {
        pagar(monto);
    });

</script>