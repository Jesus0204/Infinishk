<%- include('../includes/head.ejs', {
    username: username,
    permisos: permisos,
    rol: rol
}) %>

<section class="section">
    <div class="container">
        <h1 class="title"> Realizar Pago</h1>
        <input type="hidden" id="_csrf" name="_csrf" value="<%= csrfToken %>">
        <input class="input" type="number" name="monto" id="monto" step="any">
        <button class="button is-rounded is-medium is-responsive" type="submit"
            style="font-size: large; margin: 8px 2px;" id="Boton_pagar">
            <span>Realizar Pago</span>
            <span class="icon is-large">
                <i class="fa-solid fa-circle-chevron-right" style="color: #ffffff;"></i>
            </span>
        </button>
        <div class="columns">
            <div class="column is-3"></div>
            <div class="column is-6">
                <iframe width="100%" height="470px" id="frame_pago"></iframe>
            </div>
        </div>
    </div>
</section>

<script>
    function pagar(monto) {
        //El token de protecciÃ³n CSRF
        const csrf = document.getElementById('_csrf').value;

        fetch('/pagos/mandar_pago', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'csrf-token': csrf
            },
            body: JSON.stringify({
                monto: monto.value
            })
        }).then((result) => {
            return result.json(); //Regresa otra promesa
        }).then((data) => {

            parser = new DOMParser();
            xmlDoc = parser.parseFromString(data.respuestaXML, "text/xml");

            let liga_pago = (xmlDoc.getElementsByTagName("nb_url")[0].childNodes[0].nodeValue);

            document.getElementById('frame_pago').src = liga_pago;

        }).catch(err => {
            console.log(err);
        });
    }

    const boton_pagar = document.getElementById('Boton_pagar');
    const monto = document.getElementById('monto');
    boton_pagar.addEventListener('click', function () {
        pagar(monto);
    });

</script>